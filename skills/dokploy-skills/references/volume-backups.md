# Dokploy 볼륨 백업 가이드

## 목차

1. [개요](#개요)
2. [지원 범위](#지원-범위)
3. [볼륨 마운트 설정](#볼륨-마운트-설정)
4. [백업 생성](#백업-생성)
5. [백업 복원](#백업-복원)
6. [Docker Compose 볼륨](#docker-compose-볼륨)
7. [주의사항](#주의사항)

---

## 개요

Dokploy의 볼륨 백업 기능은 Docker 명명 볼륨을 S3 저장소로 백업할 수 있게 합니다.

**주요 용도:**
- SQLite 데이터베이스 백업
- 사용자 업로드 파일 백업
- 애플리케이션 데이터 지속성 확보

---

## 지원 범위

### 지원되는 서비스

| 서비스 유형 | 지원 여부 |
|------------|----------|
| 애플리케이션 | O |
| Docker Compose | O |

### 지원되는 마운트 타입

| 마운트 타입 | 지원 여부 | 비고 |
|------------|----------|------|
| **Volume Mount** (명명 볼륨) | O | 권장 |
| **Bind Mount** (`../files`) | X | 명명 볼륨으로 마이그레이션 필요 |

---

## 볼륨 마운트 설정

### 애플리케이션

1. **Advanced → Mounts** 이동
2. **Volume Mount** 옵션 선택
3. 볼륨 이름과 컨테이너 경로 설정

```yaml
# 예시
Volume Name: app-data
Mount Path: /app/data
```

### Docker Compose

Compose 파일에 명명 볼륨을 정의합니다:

```yaml
version: "3.8"

services:
  app:
    image: myapp:latest
    volumes:
      - app-data:/app/data
      - app-uploads:/app/uploads

volumes:
  app-data:    # 명명 볼륨 정의
  app-uploads: # 명명 볼륨 정의
```

---

## 백업 생성

### 설정 항목

| 항목 | 설명 | 예시 |
|------|------|------|
| **이름** | 백업 식별자 | `daily-backup` |
| **스케줄** | Cron 형식 | `0 0 * * *` (매일 자정) |
| **대상** | S3 저장소 | 사전 설정된 S3 대상 |
| **서비스명** | 백업할 서비스 | 자동완성 가능 |
| **볼륨명** | 백업할 볼륨 | 자동 입력 |

### Cron 스케줄 예시

| 표현식 | 설명 |
|--------|------|
| `0 0 * * *` | 매일 자정 |
| `0 */6 * * *` | 6시간마다 |
| `0 0 * * 0` | 매주 일요일 자정 |
| `0 0 1 * *` | 매월 1일 자정 |
| `*/30 * * * *` | 30분마다 |

### S3 대상 설정

S3 호환 저장소를 사전에 설정해야 합니다:

- AWS S3
- MinIO
- DigitalOcean Spaces
- Cloudflare R2
- Backblaze B2

---

## 백업 복원

### 복원 단계

1. **볼륨 백업 섹션**으로 이동
2. **Restore** 옵션 선택
3. **S3 대상** 선택
4. **백업 파일** 선택
5. **대상 볼륨명** 입력 (새 볼륨명)

### 복원 전 필수 확인사항

| 확인 항목 | 조치 |
|----------|------|
| 대상 볼륨이 이미 존재하는가? | 기존 볼륨 제거 필요 |
| 컨테이너가 볼륨을 사용 중인가? | 컨테이너 중지 필요 |

```bash
# 볼륨 확인
docker volume ls | grep app-data

# 볼륨 제거 (컨테이너 중지 후)
docker volume rm app-data
```

---

## Docker Compose 볼륨

### 볼륨 명명 규칙

Docker Compose에서 생성된 볼륨은 다음 패턴을 따릅니다:

```
{appName}_{volumeName}
```

**예시:**
- 앱 이름: `n8n-n8n-kqlble`
- Compose 볼륨: `n8n_data`
- 실제 볼륨명: `n8n-n8n-kqlble_n8n_data`

### 볼륨명 확인

```bash
docker volume ls --filter name=앱이름
```

---

## 주의사항

### 컨테이너 끄기 옵션

| 옵션 | 설명 | 권장 |
|------|------|------|
| **OFF** | 백업 중 컨테이너 중단 후 재시작 | O (데이터 무결성 보장) |
| **ON** | 컨테이너 계속 실행 | X (쓰기 중 일관성 문제 가능) |

**권장:** 데이터 손상 방지를 위해 OFF 유지 (컨테이너 중단)

### 바인드 마운트 마이그레이션

바인드 마운트(`../files`)에서 명명 볼륨으로 마이그레이션:

```bash
# 1. 임시 볼륨 생성
docker volume create app-data-temp

# 2. 데이터 복사
docker run --rm \
  -v $(pwd)/../files/data:/source:ro \
  -v app-data-temp:/dest \
  alpine cp -av /source/. /dest/

# 3. Compose 파일 수정
# volumes:
#   - "../files/data:/app/data"  # 이전
#   - "app-data:/app/data"       # 이후

# 4. 재배포
```

### 백업 저장 용량

S3 저장소 용량과 비용을 고려하여:

1. **보관 정책** 설정 (오래된 백업 자동 삭제)
2. **백업 주기** 적절히 조정
3. **증분 백업** 고려 (큰 볼륨의 경우)

---

## 빠른 체크리스트

### 백업 설정

- [ ] S3 대상 저장소 설정 완료
- [ ] 명명 볼륨 사용 확인 (바인드 마운트 X)
- [ ] 백업 스케줄 설정
- [ ] 컨테이너 끄기 옵션 OFF 확인
- [ ] 테스트 백업 실행

### 복원 준비

- [ ] 대상 볼륨이 존재하지 않는지 확인
- [ ] 관련 컨테이너 중지
- [ ] 기존 볼륨 제거 (필요시)
- [ ] 복원 실행
- [ ] 데이터 무결성 확인
- [ ] 컨테이너 재시작
